# OMERO Zarr Pixel Buffer

## Requirements

- OMERO 5.6+
- Java 11+

## Artifacts

The latest artifacts built and deployed by GitHub actions can be found on the
[Glencoe Software artifactory](https://artifacts.glencoesoftware.com/)

## Installation

Several dependencies have to be installed on the OMERO.server to make the pixel buffer working.

### With fatjar option

> Note: The `jar-with-dependencies` file contains the dependencies declared in the `build.gradle` file.
> If you prefer installing each dependency separately, please follow the [with build option](#with-build-option) section.
Clone the repository:

    git clone https://github.com/glencoesoftware/omero-zarr-pixel-buffer

Run the Gradle build including the tests

    ./gradlew fatjar

Then, install on the OMERO.server
- omero-zarr-pixel-buffer-x.x.x-jar-with-dependencies.jar, built from the above command
- [omero-py](https://pypi.org/project/omero-py/) >= 5.21.0
- `blosc` library for your system

You may need to restart the server.

### With build option

Clone the repository:

    git clone https://github.com/glencoesoftware/omero-zarr-pixel-buffer

Run the Gradle build including the tests

    ./gradlew build


Then, install on the OMERO.server (the version of the dependencies are available in the `build.gradle` file)
- omero-zarr-pixel-buffer-x.x.x.jar, built from the above command
- [omero-py](https://pypi.org/project/omero-py/) >= 5.21.0
- [caffeine](https://repo1.maven.org/maven2/com/github/ben-manes/caffeine/caffeine/)
- [jzarr](https://repo1.maven.org/maven2/dev/zarr/jzarr/)
- [s3fs](https://repo1.maven.org/maven2/org/lasersonlab/s3fs/)
- [aws-java-sdk-s3](https://repo1.maven.org/maven2/com/amazonaws/aws-java-sdk-s3/)
- `blosc` library for your system

You may need to restart the server.

## Usage

The OMERO Zarr Pixel Buffer follows the principles of a classical OMERO.server
[service extension](https://omero.readthedocs.io/en/stable/developers/Server/ExtendingOmero.html#services).

After putting the `omero-zarr-pixel-buffer.jar` under `lib/server`, the server
must be restarted. To use the ZarrPixelBuffer, an Image or Mask object must be populated with
an [ExternalInfo](https://docs.openmicroscopy.org/omero-blitz/latest/slice2html/omero/model/ExternalInfo.html)
object with the following properties:

-   `entityType` must be set to `com.glencoesoftware.ngff:multiscales`
-   `entityId` must be set to `3`
-   `lsid` must be set to the location of the corresponding Zarr multiscales group:
    - either the absolute path to the multiscales group if the Zarr is on the
      filesystem e.g. `/data/CMU-1.ome.zarr/0`
    - or the URI to the multiscales group if the Zarr is on Amazon S3 defined
      as `s3://s3.<region>.amazonaws.com/<bucket>/<key>` e.g.
      `s3://s3.us-east-1.amazonaws.com/gs-public-zarr-archive/CMU-1.ome.zarr/0`

The Zarr multiscales group must be conformant with the default layout generated by `bioformats2raw` i.e.:

-    the version of the NGFF specification must be 0.4
-    the image and the Zarr multiscales group must have 5 declared dimensions
-    the chunks must be stored in the (t, c, z, y, x) order
-    the resolution level must be downsampled along the (y, x) axis

For Zarr data hosted on AWS S3, requests must supply
[credentials](https://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/credentials.html).
OMERO Zarr Pixel Buffer looks for credentials in this order:

1.  the credentials profiles file, typically located at ~/.aws/credentials` and shared
    by the AWS CLI
2.  instance profile credentials for EC2 instances configured with a policy
    allowing to assume an IAM role

## Development

Clone the repository:

    git clone https://github.com/glencoesoftware/omero-zarr-pixel-buffer

Run the Gradle build including the tests

    ./gradlew build

## License

The converter is distributed under the terms of the GPL license. Please see [LICENSE.txt](LICENSE.txt)
for further details.
